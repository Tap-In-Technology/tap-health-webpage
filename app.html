<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Open in Tap</title>
    <link rel="icon" type="image/svg+xml" href="/media/icon.svg" />
    <meta
      name="description"
      content="Open this link in the Tap app or download it from the store."
    />
    <script>
      // Compute the current path (e.g. "/dir/id23")
      const currentPath = window.location.pathname;

      // Create and inject the meta tag dynamically
      const meta = document.createElement("meta");
      meta.name = "apple-itunes-app";
      meta.content = `app-id=6753735547, app-argument=${currentPath}, app-clip-bundle-id=com.tap-technology.tap.Clip, app-clip-display=card`;
      document.head.appendChild(meta);
    </script>
    <style>
      :root {
        --bg: #ffffff;
        --fg: #000000;
        --muted: #666666;
      }
      html,
      body {
        height: 100%;
      }
      body {
        margin: 0;
        font-family: sans-serif;
        color: var(--fg);
        background: var(--bg);
        display: flex;
        align-items: center;
        justify-content: center;
        flex: 1;
        overflow: hidden;
      }
      .wrapper {
        width: 100%;
        height: 100%;
        max-width: 720px;
        padding: 40px 20px;
        text-align: center;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: space-between;
      }
      .brand {
        flex: 2;
        display: flex;
        justify-content: center;
        align-items: end;
      }
      .content {
        flex: 7;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
      }
      .brand img {
        height: 64px;
      }
      h1 {
        font-size: 2.25rem;
        line-height: 1.2;
        margin: 0 0 12px 0;
        font-weight: 800;
        letter-spacing: -0.02em;
      }
      p.lead {
        margin: 0 0 28px 0;
        color: var(--muted);
        font-size: 1.0625rem;
        margin-bottom: 4rem;
      }
      .badges {
        display: flex;
        gap: 12px;
        justify-content: center;
        flex-wrap: wrap;
      }
      .badge {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        height: 56px;
      }
      .badge img,
      .badge svg {
        height: 100%;
        width: auto;
        display: block;
      }
      .coming-soon {
        padding: 0 16px;
        border: 1px solid #000000;
        border-radius: 8px;
        font-weight: 600;
        color: #000000;
        background: #ffffff;
        align-items: center;
        display: inline-flex;
      }
      .subtle {
        margin-top: 24px;
        color: var(--muted);
        font-size: 0.9rem;
      }
    </style>

    <!-- Apollo Website Tracker -->
    <script>
      function initApollo() {
        var n = Math.random().toString(36).substring(7),
          o = document.createElement("script");
        (o.src =
          "https://assets.apollo.io/micro/website-tracker/tracker.iife.js?nocache=" +
          n),
          (o.async = !0),
          (o.defer = !0),
          (o.onload = function () {
            window.trackingFunctions.onLoad({
              appId: "6969296afef8f30019195ad1",
            });
          }),
          document.head.appendChild(o);
      }
      initApollo();
    </script>
  </head>
  <body>
    <div class="wrapper">
      <div class="brand">
        <img src="/media/Logo.svg" alt="Tap Technology Logo" />
      </div>
      <div class="content">
        <h1>Opening Tap</h1>
        <p class="lead">
          If the app doesn't open automatically, download the app below.
        </p>
        <div class="badges">
          <a
            id="ios-badge"
            class="badge"
            href="#"
            rel="noopener"
            aria-label="Download on the App Store"
          >
            <img
              alt="Download on the App Store"
              src="https://tools.applemediaservices.com/api/badges/download-on-the-app-store/black/en-us?size=250x83"
            />
          </a>
          <a
            id="android-badge"
            class="badge"
            href="#"
            rel="noopener"
            aria-label="Get it on Google Play"
          >
            <img
              alt="Get it on Google Play"
              src="https://play.google.com/intl/en_us/badges/static/images/badges/en_badge_web_generic.png"
            />
          </a>
          <span
            id="android-soon"
            class="badge coming-soon"
            style="display: none"
            >Android coming soon</span
          >
        </div>
        <div class="subtle" id="subtle-help">
          You can close this page after the app opens.
        </div>
      </div>
    </div>
    <script>
      const LINKS = {
        IOS_APP_STORE_URL: "https://apps.apple.com/app/id6753735547",
        ANDROID_PLAY_STORE_URL:
          "https://play.google.com/store/apps/details?id=com.tap_technology.tap",
        WEB_HOME_URL: "https://tap-technology.com",
      };

      const userAgent = navigator.userAgent || navigator.vendor || window.opera;
      const IS_ANDROID = /android/i.test(userAgent);
      const IS_IOS = /iphone|ipad|ipod/i.test(userAgent);

      const iosBadge = document.getElementById("ios-badge");
      const androidBadge = document.getElementById("android-badge");
      const androidSoon = document.getElementById("android-soon");

      iosBadge.href = LINKS.IOS_APP_STORE_URL;
      androidBadge.href = LINKS.ANDROID_PLAY_STORE_URL;

      // Robust app opening detection with fallback to app stores
      function attemptOpen() {
        let appOpened = false;
        let redirectTimer = null;
        const FALLBACK_DELAY = 750; // 750 milliseconds to detect if app opened

        // Function to redirect to app store if app didn't open
        function redirectToStore() {
          if (appOpened) return; // Don't redirect if app already opened

          if (IS_IOS) {
            // window.location.href = LINKS.IOS_APP_STORE_URL;
          } else if (IS_ANDROID) {
            window.location.href = LINKS.ANDROID_PLAY_STORE_URL;
          } else {
            window.location.replace("../index.html");
          }
        }

        // Mark app as opened when page becomes hidden (user switched to app)
        function handleVisibilityChange() {
          if (document.hidden) {
            appOpened = true;
            if (redirectTimer) {
              clearTimeout(redirectTimer);
            }
          }
        }

        // Mark app as opened when window loses focus (user switched to app)
        function handleBlur() {
          appOpened = true;
          if (redirectTimer) {
            clearTimeout(redirectTimer);
          }
        }

        // Set up event listeners for detection
        document.addEventListener("visibilitychange", handleVisibilityChange);
        window.addEventListener("blur", handleBlur);

        // Set up fallback timer - redirect to store if app didn't open
        redirectTimer = setTimeout(() => {
          if (!appOpened) {
            redirectToStore();
          }
        }, FALLBACK_DELAY);

        // Platform-specific handling
        if (IS_IOS) {
          // iOS universal links should trigger automatically via apple-itunes-app meta tag
          // The visibility/blur detection will catch if it worked
          // No additional action needed - universal links handle it
        } else if (IS_ANDROID) {
          // Attempt to open the Android app via intent as a secondary method
          // Universal links should trigger automatically via assetlinks.json
          // This intent URL provides an additional fallback
          const intentUrl =
            "intent://open#Intent;scheme=tap;package=com.tap_technology.tap;S.browser_fallback_url=" +
            encodeURIComponent(LINKS.ANDROID_PLAY_STORE_URL) +
            ";end";
          // Navigate to the intent URL to trigger App Link / app open
          window.location.href = intentUrl;
        } else {
          // Desktop/other - redirect to home
          window.location.replace("../index.html");
        }
      }

      document.addEventListener("DOMContentLoaded", attemptOpen);
      if (IS_IOS) {
        androidBadge.style.display = "none";
      }
      if (IS_ANDROID) {
        iosBadge.style.display = "none";
        if (androidBadge) androidBadge.style.display = "inline-flex";
        if (androidSoon) androidSoon.style.display = "none";
      }
    </script>
  </body>
</html>
